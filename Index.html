<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard BTC/‡∏ó‡∏≠‡∏á/‡∏´‡∏∏‡πâ‡∏ô</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom gradient background for dark theme */
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #cbd5e1;
      font-family: "Noto Sans Thai", sans-serif, Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* Scrollbar hidden */
    ::-webkit-scrollbar {
      display: none;
    }
  </style>

  <!-- React, ReactDOM, Babel CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="min-h-screen flex flex-col">
  <div id="root" class="flex-1"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Helper: Thai months and weekdays for date display
    const thaiMonths = [
      "‡∏°.‡∏Ñ.",
      "‡∏Å.‡∏û.",
      "‡∏°‡∏µ.‡∏Ñ.",
      "‡πÄ‡∏°.‡∏¢.",
      "‡∏û.‡∏Ñ.",
      "‡∏°‡∏¥.‡∏¢.",
      "‡∏Å.‡∏Ñ.",
      "‡∏™.‡∏Ñ.",
      "‡∏Å.‡∏¢.",
      "‡∏ï.‡∏Ñ.",
      "‡∏û.‡∏¢.",
      "‡∏ò.‡∏Ñ.",
    ];
    const thaiWeekdays = [
      "‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå",
      "‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå",
      "‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£",
      "‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò",
      "‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ",
      "‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå",
      "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå",
    ];

    // Icon SVGs (create simple arrows)
    const UpArrow = () => (
      <svg
        className="inline-block w-4 h-4 text-green-400"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        viewBox="0 0 24 24"
      >
        <path strokeLinecap="round" strokeLinejoin="round" d="M5 15l7-7 7 7" />
      </svg>
    );

    const DownArrow = () => (
      <svg
        className="inline-block w-4 h-4 text-red-400"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        viewBox="0 0 24 24"
      >
        <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />
      </svg>
    );

    // Utils to format numbers and colors
    function formatNumber(num, decimals = 2) {
      return num != null ? num.toFixed(decimals) : "-";
    }

    // Get current Thai date string
    function getThaiDateString(date) {
      const weekday = thaiWeekdays[date.getDay()];
      const day = date.getDate();
      const month = thaiMonths[date.getMonth()];
      const year = date.getFullYear() + 543; // Buddhist Era
      return `${weekday}‡∏ó‡∏µ‡πà ${day} ${month} ${year}`;
    }

    // Hook: useInterval with cleanup
    function useInterval(callback, delay) {
      const savedCallback = useRef();

      useEffect(() => {
        savedCallback.current = callback;
      }, [callback]);

      useEffect(() => {
        if (delay !== null) {
          const id = setInterval(() => savedCallback.current(), delay);
          return () => clearInterval(id);
        }
      }, [delay]);
    }

    // Horoscope (‡∏î‡∏ß‡∏á) daily sentences (‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô/‡∏•‡∏á‡∏ó‡∏∏‡∏ô)
    const horoscopeSentences = [
      "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÅ‡∏Å‡πà‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÜ ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
      "‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç",
      "‡∏≠‡∏¢‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏£‡∏µ‡∏ö‡∏£‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô ‡∏Ñ‡∏ß‡∏£‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô",
      "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏î‡∏µ",
      "‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏ö‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß",
      "‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡πÑ‡∏£‡∏î‡∏µ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏∏‡πâ‡∏ô",
      "‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏∏‡πâ‡∏ô‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏â‡∏±‡∏ö‡∏û‡∏•‡∏±‡∏ô",
      "‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô",
    ];

    function getDailyHoroscope(date) {
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (index modulo)
      const index = date.getFullYear() + date.getMonth() + date.getDate();
      return horoscopeSentences[index % horoscopeSentences.length];
    }

    // Fetch wrapper with timeout & error handling
    async function fetchWithTimeout(resource, options = {}) {
      const { timeout = 8000 } = options;
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const response = await fetch(resource, {
          ...options,
          signal: controller.signal,
        });
        clearTimeout(id);
        if (!response.ok) throw new Error("Network response was not ok");
        return response.json();
      } catch (e) {
        clearTimeout(id);
        throw e;
      }
    }

    // Main Component
    function App() {
      // View Mode: portrait or landscape
      const [isPortrait, setIsPortrait] = useState(window.innerWidth <= window.innerHeight);

      // Time & date state
      const [now, setNow] = useState(new Date());

      // Asset data states
      const [bitcoin, setBitcoin] = useState(null);
      const [bitcoinTime, setBitcoinTime] = useState(null);
      const [goldUSD, setGoldUSD] = useState(null);
      const [goldUSDTime, setGoldUSDTime] = useState(null);
      const [goldTHB, setGoldTHB] = useState(null);
      const [goldTHBTime, setGoldTHBTime] = useState(null);
      const [sp500, setSP500] = useState(null);
      const [sp500Time, setSP500Time] = useState(null);
      const [customTickers, setCustomTickers] = useState(() => {
        // Load from localStorage (saved tickers with symbol)
        try {
          const ls = window.localStorage.getItem("customTickers");
          return ls ? JSON.parse(ls) : [];
        } catch {
          return [];
        }
      });
      const [customTickerData, setCustomTickerData] = useState({});
      const [customTickerTime, setCustomTickerTime] = useState(null);

      // News
      const [newsList, setNewsList] = useState([]);
      const [newsTime, setNewsTime] = useState(null);

      // Error states (for warnings)
      const [errors, setErrors] = useState({});

      // Handle viewport resize (update orientation)
      useEffect(() => {
        function handleResize() {
          setIsPortrait(window.innerWidth <= window.innerHeight);
        }
        window.addEventListener("resize", handleResize);
        return () => window.removeEventListener("resize", handleResize);
      }, []);

      // Update time every second (for clock)
      useInterval(() => setNow(new Date()), 1000);

      // Fetch Bitcoin every 1 min
      useEffect(() => {
        async function fetchBitcoin() {
          try {
            const data = await fetchWithTimeout(
              "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true"
            );
            if (data.bitcoin) {
              setBitcoin({
                price: data.bitcoin.usd,
                change: data.bitcoin.usd_24h_change,
              });
              setBitcoinTime(new Date());
              setErrors((e) => ({ ...e, bitcoin: false }));
            } else {
              throw new Error("Invalid BTC data");
            }
          } catch {
            setErrors((e) => ({ ...e, bitcoin: true }));
          }
        }
        fetchBitcoin();
        const intervalId = setInterval(fetchBitcoin, 60 * 1000);
        return () => clearInterval(intervalId);
      }, []);

      // Fetch Gold USD every 5 mins
      useEffect(() => {
        async function fetchGoldUSD() {
          try {
            // Using metals-api.com free endpoint (simulate with metals.dev)
            const response = await fetchWithTimeout(
              "https://metals-api.com/api/latest?access_key=demo&base=USD&symbols=XAU"
            );
            // metals-api limited free version does not work without key
            // We use fallback with "https://www.metals-api.com/api/latest?access_key=demo&base=USD&symbols=XAU" - demo key limited. So fallback to Gold-API (https://www.goldapi.io/) or metals.live will break since no key
            // Instead fetch from metals.live (free, no key needed) https://api.metals.live/v1/spot
            // So use metals.live api here:

            // Using metals.live API directly for gold price in USD/oz
            const liveData = await fetchWithTimeout(
              "https://api.metals.live/v1/spot/gold"
            );
            // liveData example: [{timestamp:..., price:...}]
            if (liveData.length > 0 && liveData[0].price) {
              setGoldUSD({ price: liveData[0].price });
              setGoldUSDTime(new Date());
              setErrors((e) => ({ ...e, goldUSD: false }));
            } else {
              throw new Error("Invalid Gold USD data");
            }
          } catch {
            setErrors((e) => ({ ...e, goldUSD: true }));
          }
        }
        fetchGoldUSD();
        const intervalId = setInterval(fetchGoldUSD, 5 * 60 * 1000);
        return () => clearInterval(intervalId);
      }, []);

      // Fetch Gold THB from goldtraders.or.th every 5 mins (via allorigins proxy)
      useEffect(() => {
        async function fetchGoldTHB() {
          try {
            // goldtraders.or.th data page: http://www.goldtraders.or.th/
            // Get current price for gold 96.5% (‡∏ö‡∏≤‡∏ó/‡∏™‡∏•‡∏∂‡∏á)
            // We'll parse price from html text via proxy
            const htmlResponse = await fetchWithTimeout(
              "https://api.allorigins.win/get?url=" +
                encodeURIComponent("http://goldtraders.or.th/")
            );
            if (htmlResponse && htmlResponse.contents) {
              const parser = new DOMParser();
              const doc = parser.parseFromString(htmlResponse.contents, "text/html");

              // Price element: ‡∏´‡∏≤ <span id="spnAmount"> (‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥96.5%) ‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤
              // ‡∏à‡∏£‡∏¥‡∏á‡πÜ goldtraders.or.th ‡∏°‡∏µ table ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥
              // ‡πÇ‡∏î‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ 96.5% ‡∏ö‡∏≤‡∏ó/‡∏™‡∏•‡∏∂‡∏á ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô element ‡∏Å‡∏±‡∏ö id ‡∏´‡∏£‡∏∑‡∏≠ class ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏î‡πâ
              // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á ‡∏£‡∏≠ fallback ‡∏ñ‡πâ‡∏≤ parser ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
              // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: <td class="text-right pr-1">‡∏£‡∏≤‡∏Ñ‡∏≤</td><td id="spnAmount"> price </td>
              const priceElement = doc.querySelector("#spnAmount");
              if (priceElement) {
                const price = parseFloat(priceElement.textContent.replace(/[^0-9.]/g, ""));
                if (!isNaN(price)) {
                  setGoldTHB({ price });
                  setGoldTHBTime(new Date());
                  setErrors((e) => ({ ...e, goldTHB: false }));
                  return;
                }
              }
              // Fallback: scrape from any table with "‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ 96.5%" text next row
              const tds = Array.from(doc.querySelectorAll("table tr td"));
              for (let i = 0; i < tds.length; i++) {
                if (tds[i].textContent.includes("96.5%")) {
                  // Value in same row or next row
                  let valTd = tds[i].parentElement.querySelector("td:nth-child(2)");
                  if (!valTd) valTd = tds[i + 1];
                  if (valTd) {
                    const val = parseFloat(valTd.textContent.replace(/[^0-9.]/g, ""));
                    if (!isNaN(val)) {
                      setGoldTHB({ price: val });
                      setGoldTHBTime(new Date());
                      setErrors((e) => ({ ...e, goldTHB: false }));
                      return;
                    }
                  }
                }
              }
              throw new Error("Gold THB price not found");
            } else {
              throw new Error("No contents from proxy");
            }
          } catch {
            setErrors((e) => ({ ...e, goldTHB: true }));
          }
        }
        fetchGoldTHB();
        const intervalId = setInterval(fetchGoldTHB, 5 * 60 * 1000);
        return () => clearInterval(intervalId);
      }, []);

      // Fetch S&P500 every 5 mins (Yahoo Finance unofficial)
      useEffect(() => {
        async function fetchSP500() {
          try {
            // Endpoint: https://query1.finance.yahoo.com/v7/finance/quote?symbols=%5EGSPC
            const res = await fetchWithTimeout(
              "https://query1.finance.yahoo.com/v7/finance/quote?symbols=%5EGSPC"
            );
            if (res.quoteResponse && res.quoteResponse.result.length > 0) {
              const quote = res.quoteResponse.result[0];
              setSP500({
                price: quote.regularMarketPrice,
                changePercent: quote.regularMarketChangePercent,
              });
              setSP500Time(new Date());
              setErrors((e) => ({ ...e, sp500: false }));
            } else {
              throw new Error("SP500 Not found");
            }
          } catch {
            setErrors((e) => ({ ...e, sp500: true }));
          }
        }
        fetchSP500();
        const intervalId = setInterval(fetchSP500, 5 * 60 * 1000);
        return () => clearInterval(intervalId);
      }, []);

      // Fetch custom tickers (stock) every 5 mins with Yahoo Finance
      useEffect(() => {
        if (customTickers.length === 0) {
          setCustomTickerData({});
          setCustomTickerTime(null);
          return;
        }
        async function fetchCustom() {
          try {
            // Query multiple symbols
            const symbols = customTickers.map((t) => t.symbol).join(",");
            const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols}`;
            const res = await fetchWithTimeout(url);
            if (res.quoteResponse && res.quoteResponse.result.length > 0) {
              // Map symbol -> {price, changePercent}
              let data = {};
              for (const q of res.quoteResponse.result) {
                data[q.symbol.toUpperCase()] = {
                  price: q.regularMarketPrice,
                  changePercent: q.regularMarketChangePercent,
                };
              }
              setCustomTickerData(data);
              setCustomTickerTime(new Date());
              setErrors((e) => ({ ...e, customTickers: false }));
            } else {
              throw new Error("Custom tickers no data");
            }
          } catch {
            setErrors((e) => ({ ...e, customTickers: true }));
          }
        }
        fetchCustom();
        const intervalId = setInterval(fetchCustom, 5 * 60 * 1000);
        return () => clearInterval(intervalId);
      }, [customTickers]);

      // Fetch news (4-5 news) every 5 mins - source: free RSS news or public API
      // Since no direct free Bitcoin/stock/gold news API without key,
      // We'll use CoinGecko's news RSS or newsapi.org demo or fallback to quick sample

      useEffect(() => {
        async function fetchNews() {
          try {
            // Use CoinGecko status updates API (free)
            const res = await fetchWithTimeout(
              "https://api.coingecko.com/api/v3/status_updates"
            );
            if (res.status_updates && res.status_updates.length > 0) {
              const filtered = res.status_updates
                .filter((item) => {
                  const msg = item.description.toLowerCase();
                  return (
                    msg.includes("bitcoin") ||
                    msg.includes("gold") ||
                    msg.includes("stock") ||
                    msg.includes("market") ||
                    msg.includes("btc") ||
                    msg.includes("s&p")
                  );
                })
                .slice(0, 5);
              setNewsList(
                filtered.map((item) => ({
                  title: item.description,
                  time: new Date(item.created_at),
                }))
              );
              setNewsTime(new Date());
              setErrors((e) => ({ ...e, news: false }));
            } else {
              throw new Error("No news found");
            }
          } catch {
            // fallback - static sample news
            setNewsList([
              {
                title:
                  "‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏∏‡πâ‡∏ô‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏™‡∏´‡∏£‡∏±‡∏ê‡πÑ‡∏°‡πà‡∏™‡∏î‡πÉ‡∏™",
                time: new Date(),
              },
              {
                title:
                  "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á",
                time: new Date(),
              },
              {
                title: "Bitcoin ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô",
                time: new Date(),
              },
            ]);
            setNewsTime(null);
            setErrors((e) => ({ ...e, news: false }));
          }
        }
        fetchNews();
        const intervalId = setInterval(fetchNews, 5 * 60 * 1000);
        return () => clearInterval(intervalId);
      }, []);

      // Manage custom tickers add/remove with validation (only letters, dot allowed)
      const newTickerRef = React.useRef();
      function addCustomTicker() {
        if (!newTickerRef.current) return;
        const value = newTickerRef.current.value.trim().toUpperCase();
        if (
          value &&
          !customTickers.find((t) => t.symbol === value) &&
          /^[A-Z0-9.]{1,8}$/.test(value)
        ) {
          const updated = [...customTickers, { symbol: value }];
          setCustomTickers(updated);
          localStorage.setItem("customTickers", JSON.stringify(updated));
          newTickerRef.current.value = "";
        }
      }
      function removeCustomTicker(symbol) {
        const updated = customTickers.filter((t) => t.symbol !== symbol);
        setCustomTickers(updated);
        localStorage.setItem("customTickers", JSON.stringify(updated));
      }

      // Check if data is stale (> 1 hour) for warning yellow text
      function isStale(updatedTime) {
        if (!updatedTime) return true;
        const diff = (new Date() - new Date(updatedTime)) / 1000;
        return diff > 3600; // 1 hour seconds
      }

      // Format time update string
      function timeSince(date) {
        if (!date) return "-";
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return `${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
        else if (seconds < 3600)
          return `${Math.floor(seconds / 60)} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
        else if (seconds < 86400)
          return `${Math.floor(seconds / 3600)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
        else return "> 1 ‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
      }

      // Color logic for price change
      function priceColor(change) {
        if (change > 0) return "text-green-400";
        else if (change < 0) return "text-red-400";
        return "text-gray-300";
      }

      function PriceChangeIcon({change}) {
        if (change > 0) return <UpArrow />;
        else if (change < 0) return <DownArrow />;
        return null;
      }

      // --- COMPONENTS ---
      // Big Clock with Thai date
      const Clock = () => (
        <div className="text-center px-4 select-none">
          <div
            className="font-mono font-bold text-[4.5rem] md:text-[6rem] leading-none"
            aria-label="‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"
          >
            {now.toLocaleTimeString("th-TH", {
              hour12: false,
            })}
          </div>
          <div className="text-yellow-400 font-medium text-lg sm:text-xl">
            {getThaiDateString(now)}
          </div>
        </div>
      );

      // Horoscope daily text
      const Horoscope = () => {
        const horoText = getDailyHoroscope(now);
        return (
          <div
            className="mt-4 p-3 rounded-md bg-gradient-to-r from-yellow-600 to-yellow-400 text-black font-semibold text-center"
            aria-live="polite"
          >
            üåü ‡∏î‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: {horoText}
          </div>
        );
      };

      // Single asset card
      function AssetCard({ label, price, changePercent, stale, warning, unit }) {
        const priceStr =
          price != null ? (unit ? price + " " + unit : price.toLocaleString()) : "-";
        const changeStr =
          changePercent != null ? `${formatNumber(changePercent, 2)}%` : "-";
        const colorClass = priceColor(changePercent);

        return (
          <div
            className={`p-3 rounded-md min-w-[150px] ${
              stale
                ? "bg-yellow-900"
                : "bg-gradient-to-br from-gray-800 to-gray-900"
            } text-white`}
            aria-label={`${label} ‡∏£‡∏≤‡∏Ñ‡∏≤ ${
              priceStr
            } ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ${changeStr} ${stale ? "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤" : ""}`}
          >
            <div className="font-bold text-lg">{label}</div>
            <div className="text-2xl font-extrabold flex items-center gap-1">
              {priceStr}
              <span className={`${colorClass} flex items-center`}>
                <PriceChangeIcon change={changePercent || 0} />
                {changeStr}
              </span>
            </div>
            {warning && (
              <div className="text-yellow-300 text-xs mt-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ä‡πâ‡∏≤)</div>
            )}
          </div>
        );
      }

      // News list component
      function NewsList({ news }) {
        if (!news || news.length === 0)
          return <div className="italic text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>;

        return (
          <ul className="space-y-2 overflow-auto max-h-52 pr-1">
            {news.map((item, i) => (
              <li
                key={i}
                className="text-sm text-gray-300 border-b border-gray-700 pb-1"
                title={item.title}
              >
                <div className="truncate">{item.title}</div>
                <div className="text-xs text-gray-500">
                  {item.time ? item.time.toLocaleTimeString("th-TH", {hour: "2-digit", minute:"2-digit"}) : "-"}
                </div>
              </li>
            ))}
          </ul>
        );
      }

      // Custom tickers list + add input
      function CustomTickers() {
        return (
          <section className="my-4">
            <h3 className="font-semibold text-lg mb-1 text-white">‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á)</h3>
            <div className="flex gap-2 mb-2">
              <input
                ref={newTickerRef}
                type="text"
                inputMode="text"
                maxLength={8}
                className="flex-1 rounded-md bg-gray-700 text-white px-3 py-2 placeholder-gray-400 focus:outline-yellow-300"
                placeholder="‡πÉ‡∏™‡πà ticker ‡πÄ‡∏ä‡πà‡∏ô AAPL, PTT"
                onKeyDown={e => {
                  if (e.key === "Enter") {
                    addCustomTicker();
                  }
                }}
                aria-label="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°"
                autoComplete="off"
              />
              <button
                className="bg-yellow-400 text-black rounded-md px-3 font-semibold hover:bg-yellow-300 transition"
                onClick={addCustomTicker}
                aria-label="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏∏‡πâ‡∏ô"
                type="button"
              >
                ‡πÄ‡∏û‡∏¥‡πà‡∏°
              </button>
            </div>
            {customTickers.length === 0 && (
              <div className="text-gray-400 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°</div>
            )}
            <div className="space-y-2 max-h-48 overflow-auto">
              {customTickers.map(({ symbol }) => {
                const data = customTickerData[symbol];
                const stale = isStale(customTickerTime);
                const warning = errors.customTickers && !data;
                return (
                  <div
                    key={symbol}
                    className={`flex justify-between items-center bg-gray-800 p-2 rounded-md ${
                      stale ? "bg-yellow-900" : ""
                    }`}
                  >
                    <div className="font-semibold text-lg">{symbol}</div>
                    <div className="flex items-center gap-2 text-white">
                      {data ? (
                        <>
                          <span className="text-2xl font-bold">
                            {data.price ? data.price.toLocaleString() : "-"}
                          </span>
                          <span className={priceColor(data.changePercent)}>
                            <PriceChangeIcon change={data.changePercent || 0} />
                            {data.changePercent ? data.changePercent.toFixed(2) : "-"}%
                          </span>
                        </>
                      ) : (
                        <div className="italic text-yellow-300 text-sm">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
                      )}
                      <button
                        aria-label={`‡∏•‡∏ö‡∏´‡∏∏‡πâ‡∏ô ${symbol}`}
                        onClick={() => removeCustomTicker(symbol)}
                        className="text-red-500 hover:text-red-400 select-none"
                        type="button"
                      >
                        ‚úï
                      </button>
                    </div>
                  </div>
                );
              })}
              {errors.customTickers && (
                <div className="text-yellow-300 text-xs mt-1">
                  ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏≠‡∏≤‡∏à‡∏•‡πâ‡∏≤‡∏™‡∏°‡∏±‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                </div>
              )}
            </div>
          </section>
        );
      }

      // Update Footer info
      function FooterInfo() {
        return (
          <footer className="mt-4 text-center text-xs text-gray-400 select-none mb-1">
            <div>
              ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:{" "}
              <span
                className={
                  isStale(
                    [
                      bitcoinTime,
                      goldUSDTime,
                      goldTHBTime,
                      sp500Time,
                      customTickerTime,
                      newsTime,
                    ].find((t) => t != null)
                  )
                    ? "text-yellow-400"
                    : "text-gray-400"
                }
              >
                {[
                  bitcoinTime,
                  goldUSDTime,
                  goldTHBTime,
                  sp500Time,
                  customTickerTime,
                  newsTime,
                ]
                  .filter((t) => t != null)
                  .map((t) => timeSince(t))
                  .join(", ")}
              </span>
            </div>
            <div>‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ Perplexity AI - ‡πÉ‡∏ä‡πâ API ‡∏ü‡∏£‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </footer>
        );
      }

      // UI Mode toggle button (portrait/landscape)
      function ModeToggle() {
        return (
          <button
            aria-label="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á/‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô"
            onClick={() => setIsPortrait(!isPortrait)}
            className="absolute top-3 right-3 bg-gray-700 bg-opacity-90 text-yellow-400 px-3 py-1 rounded-md transition hover:bg-yellow-400 hover:text-black select-none focus:outline-none focus:ring-2 focus:ring-yellow-400"
          >
            ‡πÇ‡∏´‡∏°‡∏î {isPortrait ? "‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô" : "‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á"}
          </button>
        );
      }

      // Render main layout by mode
      if (isPortrait) {
        // PORTRAIT
        return (
          <div className="relative max-w-lg mx-auto py-3 px-3 flex flex-col min-h-screen">
            <ModeToggle />
            <header>
              <Clock />
              <Horoscope />
            </header>
            <main className="mt-4">
              <section aria-label="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏•‡∏±‡∏Å" className="grid grid-cols-2 gap-3">
                <AssetCard
                  label="Bitcoin (USD)"
                  price={bitcoin?.price}
                  changePercent={bitcoin?.change}
                  stale={isStale(bitcoinTime)}
                  warning={errors.bitcoin && isStale(bitcoinTime)}
                  unit="USD"
                />
                <AssetCard
                  label="‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ (USD/‡∏≠‡∏≠‡∏ô‡∏ã‡πå)"
                  price={goldUSD?.price}
                  changePercent={null}
                  stale={isStale(goldUSDTime)}
                  warning={errors.goldUSD && isStale(goldUSDTime)}
                  unit="USD"
                />
                <AssetCard
                  label="‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥‡πÑ‡∏ó‡∏¢ (‡∏ö‡∏≤‡∏ó/‡∏™‡∏•‡∏∂‡∏á)"
                  price={goldTHB?.price}
                  changePercent={null}
                  stale={isStale(goldTHBTime)}
                  warning={errors.goldTHB && isStale(goldTHBTime)}
                  unit="‡∏ö‡∏≤‡∏ó"
                />
                <AssetCard
                  label="S&P 500 Index"
                  price={sp500?.price}
                  changePercent={sp500?.changePercent}
                  stale={isStale(sp500Time)}
                  warning={errors.sp500 && isStale(sp500Time)}
                />
              </section>
              <CustomTickers />
              <section>
                <h3 className="font-semibold text-lg mb-2">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <NewsList news={newsList} />
                {errors.news && (
                  <div className="text-yellow-300 mt-1 text-xs">
                    ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏à‡∏•‡πâ‡∏≤‡∏™‡∏°‡∏±‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                  </div>
                )}
              </section>
            </main>
            <FooterInfo />
          </div>
        );
      } else {
        // LANDSCAPE - 3 columns layout
        return (
          <div className="relative max-w-7xl mx-auto py-3 px-4 flex flex-col min-h-screen">
            <ModeToggle />
            <div className="flex flex-row gap-4 flex-wrap">
              <section
                aria-label="‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢"
                className="flex flex-col gap-4 flex-[1_1_25%] min-w-[250px]"
              >
                <Clock />
                <Horoscope />
                <AssetCard
                  label="Bitcoin (USD)"
                  price={bitcoin?.price}
                  changePercent={bitcoin?.change}
                  stale={isStale(bitcoinTime)}
                  warning={errors.bitcoin && isStale(bitcoinTime)}
                  unit="USD"
                />
                <AssetCard
                  label="‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ (USD/‡∏≠‡∏≠‡∏ô‡∏ã‡πå)"
                  price={goldUSD?.price}
                  changePercent={null}
                  stale={isStale(goldUSDTime)}
                  warning={errors.goldUSD && isStale(goldUSDTime)}
                  unit="USD"
                />
              </section>

              <section
                aria-label="‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Å‡∏•‡∏≤‡∏á"
                className="flex flex-col gap-4 flex-[1_1_45%] min-w-[350px]"
              >
                <AssetCard
                  label="S&P 500 Index"
                  price={sp500?.price}
                  changePercent={sp500?.changePercent}
                  stale={isStale(sp500Time)}
                  warning={errors.sp500 && isStale(sp500Time)}
                />
                <AssetCard
                  label="‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥‡πÑ‡∏ó‡∏¢ (‡∏ö‡∏≤‡∏ó/‡∏™‡∏•‡∏∂‡∏á)"
                  price={goldTHB?.price}
                  changePercent={null}
                  stale={isStale(goldTHBTime)}
                  warning={errors.goldTHB && isStale(goldTHBTime)}
                  unit="‡∏ö‡∏≤‡∏ó"
                />
                <CustomTickers />
              </section>

              <section
                aria-label="‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£"
                className="flex flex-col gap-2 flex-[1_1_25%] min-w-[250px]"
              >
                <h3 className="font-semibold text-lg mb-2 text-white">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <NewsList news={newsList} />
                {errors.news && (
                  <div className="text-yellow-300 mt-1 text-xs">
                    ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏à‡∏•‡πâ‡∏≤‡∏™‡∏°‡∏±‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                  </div>
                )}
              </section>
            </div>
            <FooterInfo />
          </div>
        );
      }
    }

    // Render app
    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
